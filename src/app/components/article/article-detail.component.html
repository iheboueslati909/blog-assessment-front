<div *ngIf="!loading" class="p-6">
  <div *ngIf="error" class="text-red-500">{{ error }}</div>

  <div *ngIf="article" class="prose prose-invert max-w-none">
    <h1 class="text-3xl font-bold">{{ article.title }}</h1>
    <p class="text-sm text-gray-400">By {{ article.authorId }} {{ article.createdAt | date }}</p>

    <img *ngIf="article.image" [src]="article.image" alt="article image" class="w-full rounded-md my-4" />

    <div class="mt-4" [innerHTML]="article.content"></div>

    <div class="mt-6 flex gap-3">
      <button 
        (click)="edit()" 
        class="px-3 py-1.5 bg-yellow-600 text-white rounded"
        *ngIf="canEdit()">
        Edit
      </button>
      <button 
        (click)="remove()" 
        class="px-3 py-1.5 bg-red-600 text-white rounded"
        *ngIf="canDelete()">
        Delete
      </button>
      <button routerLink="/articles" class="px-3 py-1.5 bg-gray-700 text-white rounded">Back</button>
    </div>
  </div>

  <!-- Article content here ... -->

<h2 class="mt-8 text-xl font-bold">Comments</h2>
<div class="text-sm text-gray-400">Top-level comments: {{ commentsTotalTopLevel }}</div>

<!-- Add new comment -->
<div class="my-4">
  <textarea [(ngModel)]="newCommentContent" rows="3" class="w-full border rounded p-2"></textarea>
  <button (click)="addComment()" class="mt-2 px-3 py-1.5 bg-blue-600 text-white rounded">Post Comment</button>
</div>

<!-- List comments -->
<div *ngIf="comments?.length === 0" class="text-gray-500">No comments yet. Be the first to comment.</div>

<ng-template #commentNode let-comment>
  <div class="border-b py-2">
    <p class="text-sm text-gray-500">{{ comment.authorId }} | {{ comment.createdAt | date:'short' }}</p>
    <p>{{ comment.content }}</p>

    <!-- Reply button -->
    <button class="text-blue-500 text-sm mt-1" (click)="toggleReplyBox(comment._id)">
      {{ replyOpenFor[comment._id] ? 'Cancel' : 'Reply' }}
    </button>

    <!-- Reply input -->
    <div *ngIf="replyOpenFor[comment._id]" class="mt-2">
      <textarea [(ngModel)]="replyContent[comment._id]" rows="2" class="w-full border rounded p-2"></textarea>
      <button
        (click)="addComment(comment._id)"
        class="mt-1 px-3 py-1.5 bg-blue-600 text-white rounded"
      >
        Post Reply
      </button>
    </div>

    <!-- Render replies recursively -->
    <div class="ml-6 mt-2" *ngFor="let child of comment.replies || []">
      <ng-container *ngTemplateOutlet="commentNode; context: { $implicit: child }"></ng-container>
    </div>
  </div>
</ng-template>

<div *ngFor="let c of comments">
  <ng-container *ngTemplateOutlet="commentNode; context: { $implicit: c }"></ng-container>
</div>
<div *ngIf="loading" class="p-6 text-gray-400">Loading...</div>
